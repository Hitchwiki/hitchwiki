---
# Devlopment specific tasks

# Maildev
- name: Install PHP PEAR modules
  become: true
  pear: name={{item}} state=present
  with_items: { Auth_SASL, mail, mail_mime, Net_SMTP }

- name: Install Maildev for catching emails while developing
  become: true
  npm: name=maildev version=1.0.0-rc3 state=present global=yes
  notify: restart maildev

- name: Setup Maildev to start on reboot
  become: true
  file: state=link src={{ dir.script }}/init_maildev.sh path=/etc/init.d/maildev mode='755'

- name: Create Maildev startup symlink
  # TODO insserv Script maildev is broken incomplete LSB comment.
  become: true
  file: state=link src=/etc/init.d/maildev path=/etc/rc3.d/S99maildev

# MariaDB
- name: Save db credentials locally
  # See https://dev.mysql.com/doc/refman/5.7/en/option-files.html
  # TODO use vault instead
  copy:
    dest: ~/.my.cnf
    content: |
      [client]
      user={{db.username}}
      password={{db.password}}

# PHP debug
# https://github.com/Hitchwiki/hitchwiki/blob/master/configs/mediawiki.php#L59-L63
- name: Turn on PHP error reporting
  become: true
  lineinfile:
    path: /etc/php/7.0/apache2/php.ini
    regexp: '^error_reporting = .*'
    line: 'error_reporting = E_ALL'
  when: debug
  notify: restart apache

- name: Display PHP errors
  become: true
  lineinfile:
    path: /etc/php/7.0/apache2/php.ini
    regexp: '^display_errors = .*'
    line: 'display_errors = On'
  when: debug
  notify: restart apache

- name: Turn off PHP error reporting
  become: true
  lineinfile:
    path: /etc/php/7.0/apache2/php.ini
    regexp: '^error_reporting = E_ALL'
    line: 'error_reporting = .*'
  when: not debug
  notify: restart apache

- name: Hide PHP errors
  become: true
  lineinfile:
    path: /etc/php/7.0/apache2/php.ini
    regexp: '^display_errors = On'
    line: 'display_errors = .*'
  when: not debug
  notify: restart apache

# PHPMyAdmin
- import_tasks: roles/web/tasks/main.yml
  when: not finished_web_tasks
- name: Configure PHPMyAdmin
  become: true
  # TODO maybe use https://docs.ansible.com/ansible/latest/dpkg_selections_module.html
  # TODO Is it necessary to run this before the installation of the phpmyadmin package?
  shell: |
    debconf-set-selections <<< "phpmyadmin phpmyadmin/reconfigure-webserver multiselect apache2"
    debconf-set-selections <<< "phpmyadmin phpmyadmin/dbconfig-install boolean true"
    debconf-set-selections <<< "phpmyadmin phpmyadmin/mysql/admin-user string {{db.username}}"
    debconf-set-selections <<< "phpmyadmin phpmyadmin/mysql/admin-pass password {{db.password}}"
    debconf-set-selections <<< "phpmyadmin phpmyadmin/mysql/app-pass password {{db.phpmyadmin_password}}"
    debconf-set-selections <<< "phpmyadmin phpmyadmin/app-password-confirm password {{db.phpmyadmin_password}}"
  notify: restart apache

- name: Add PHPMyAdmin configuration to Apache
  become: true
  lineinfile:
    path: /etc/phpmyadmin/apache.conf
    regexp: '(Alias /).*(/usr/share/phpmyadmin)'
    line: '\1{{ dir.phpmyadmin }} \2'
  notify: restart apache

- name: Finish development tasks
  lineinfile:
    path: "{{ dir.settings }}"
    regexp: '^finished_dev_tasks'
    line: 'finished_dev_tasks: True'

...
