---
# Productive environment

# TODO use https://docs.ansible.com/ansible/latest/letsencrypt_module.html
# Check https://letsencrypt.org/2017/10/17/acme-support-in-apache-httpd.html
- name: Enable SSL support in Apache
  become: yes
  apache2_module: name=ssl state=present
  notify: restart apache

- name: Setup self signed SSL certificate
  shell: |
    cd {{ROOTDIR}}
    if [[ $* == *--ssl* ]]; then
      bash {{SCRIPTDIR}}/cert_selfsigned.sh
    else
      msg "Skipped installing self signed SSL certificate."
    fi
  when: setup_ssl

# Monit
#- name: Clone into Monit 
#  git: repo: git clone=https://tildeslash@bitbucket.org/tildeslash/monit.git dest=~/moniit depth=1

#- name: Install monit dependencies
#  apt: name={{item}} state=present
#  with_items: { automake bison byacc flex libpam0g-dev } # libtool m4

#- name: Build monit
#  shell: |
#    cd ~/monit
#    ./configure
#    make

#- name: Install monit
#  become: yes
#  shell: cd /home/{{ ansible_user_id }}/monit; make install
- name: Install monit
  apt: name=monit state=present

- name: Monitor services
  monit: name={{item}} state=started
  # https://docs.ansible.com/ansible/latest/monit_module.html
  with_items:
    - apache2
    - mariadb
    - 
# TODO untested

- name: Finish installation
  lineinfile:
    path: "{{ dir.settings }}"
    regexp: '^finished_installation'
    line: 'finished_installation: True'
  when: finished_common_tasks and finished_db_tasks and finished_web_tasks and finished_mw_tasks
  notify: status

...
